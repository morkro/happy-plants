import React, { useState } from 'react'
import styled from 'styled-components'
import { theme } from 'theme'
import { FirebaseError } from 'firebase/app'
import { routeConfigMap } from 'routes'
import { AppHeaderPortal } from 'components/AppHeader'
import { Button } from 'components/Button'
import { Text } from 'components/Typography'
import { Input, Textarea } from 'components/Input'
import Spinner from 'components/Spinner'
import { addBugReport } from 'services/firebase'
import { toast } from 'components/Toaster'
import logger from 'utilities/logger'
import getErrorMessage from 'utilities/getErrorMessage'
import BaseSVG from 'components/BaseSVG'
import useUserInfo from 'utilities/useUserInfo'
import Layout from 'components/Layout'

const HeaderIllustration = styled(BaseSVG)`
  width: 104px;
  display: block;
  position: absolute;
  right: 0;
  top: 0;
  transform: translate(-17%, 34%);
`

const BugReportHeader = styled.div`
  width: ${({ theme }) => `calc(100% + 2 * ${theme.spacings.m})`};
  margin-bottom: ${({ theme }) => theme.spacings.m};

  & svg {
    width: 100%;
  }
`

const BugReportForm = styled.form`
  display: flex;
  flex-direction: column;
  width: 100%;

  label {
    position: relative;
    margin-bottom: ${(props) => props.theme.spacings.m};
  }
`

export default function SettingsBugReport() {
  const routeConfig = routeConfigMap.get('settingsBugReport')
  const userInfo = useUserInfo()
  const [description, setDescription] = useState({ value: '', invalid: false, error: '' })
  const [file, setFile] = useState<{ value: File | null; invalid: boolean; error: string }>({
    value: null,
    invalid: false,
    error: '',
  })
  const [isProgress, setIsProgress] = useState(false)

  async function submitBug(event: React.FormEvent<HTMLFormElement>) {
    event.preventDefault()
    setIsProgress(true)

    try {
      await addBugReport({
        description: description.value,
        screenshot: file.value,
        reportedBy: {
          userId: userInfo.id,
          email: userInfo.email,
        },
      })
      toast.success('Thank you for reporting this bug. We will look into it!')
      setDescription((d) => ({ ...d, value: '' }))
    } catch (error: unknown) {
      const errorMessage = getErrorMessage(error as FirebaseError)
      logger(errorMessage.message, true)
      toast.error(errorMessage.message)
    } finally {
      setIsProgress(false)
    }
  }

  return (
    <Layout {...routeConfig}>
      <AppHeaderPortal.Source>
        <HeaderIllustration viewBox="0 0 104 86">
          <g fill="none" fillRule="evenodd">
            <path
              fill={theme.colors.red}
              d="M84.277656 44.383686c.743125 4.259099-.40409-1.25526 4.288604 20.478317.173896.800856.491663 1.605478.085071 2.405079-.947045.385365.360303.740603-18.316642-9.558808-.681823.47951.430362-1.32932-14.682338 26.287662-.44037.804622-1.02336 2.059882-1.678911 2.00214-.6543-.056486-.873234-1.351915-1.20101-2.826846-.017514-.075315-5.96126-26.861315-5.96251-26.935376-.033779-1.547736-.979573-2.062393-2.354479-2.38876-2.083-.493318-15.860829-3.866202-17.915055-4.587977-.241453-.085357-.456634-.453149-.531697-.731817-.253963-.927637 5.066758-2.05235 14.940055-6.22609-1.947887-4.07081-12.740706-22.34991-13.652723-24.355817-.221436-.485785.042536-1.06697.575484-1.191242.46539-.107952.99959-.179502 1.442462-.053976.040034.010042 18.269102 8.983898 20.259525 9.91279 1.24855-1.005463 9.586807-22.85829 11.523434-26.38306.19141-.346452.889497-.2862 1.050883.07908.724359 1.63937 6.097624 18.736016 7.24734 20.99423C73.693762 19.169272 93.486645 6.82002 95.507093 6.11331c.14387-.05021.661806.395407.636785.55608-.245206 1.609244-1.048381 2.403823-9.980888 21.955758.243955.947722-.770647-.02134 15.192768 11.57601.81068.588718 1.610103 1.191243 2.383252 1.82515.161386.133057.312763.494572.243956.645203-.357801.771985-.900757.718009-2.387006.787048-18.790791.877427-14.519702.62512-17.318304.925127"
            />
            <path
              fill="#1F2421"
              d="M66.998688 45.104344c.064404 2.79862-2.258194 3.57035-3.300747 2.307634-.8963-1.085205-.937894-3.632038-.075138-4.751234.64539-.839713 1.759056-.881258 2.517154-.112046.717845.730185.845313 1.624031.85873 2.555646M61.99796 37.632913c.042645.6564-.589723 1.325885-1.284232 1.365138-.83341.045796-1.69119-.722912-1.713121-1.534144-.048738-1.831815 2.853577-2.127304 2.997353.169006M68 36.77627c-.138186.333146-.194176.550079-.31211.7327-.260886.406196-.931566.592138-1.47359.43608-1.281796-.370778-1.81548-2.257872-.259694-2.858864.495564-.192583 1.174583-.06198 1.46525.38738.27399.42169.41575.91643.580144 1.302703"
            />
            <path
              fill={theme.colors.yellow}
              d="M20.149325 55.201202c4.339951 3.914063 5.260377 4.653685 5.260377 4.653685 1.120329 1.039387.57044 1.537362-1.012593 3.477876-.359327.439858-.79463.532234-1.325214.2808-.444644-.211059-.315112-.151718-5.955366-2.422584-.349986.431905-.19928-.055059-1.17264 8.394008-.069126.598304-.222322 1.150727-.80584 1.237597-.978964.1456-1.963533.32913-3.032174-.035482-.419734-1.441927-.906102-6.4694-1.477165-9.570429-1.497093.390917.208622-.143153-7.307359 3.414864-.348117.164565-.675684.10033-.899875-.178635-.565457-.702916-1.110987-1.421738-1.636589-2.15402-.452117-.629504.309507-1.021033.714295-1.323856C6.674865 57.10501 5.411926 58.07282 6.37034 57.19861c-.338777-.571999-.505674-.48207-4.580333-3.856558-.475159-.393364-.921049-.824045-1.352615-1.263903-.486991-.49614-.579781-1.076092-.215472-1.679903 1.716924-2.8447 1.750553-2.979288 2.745086-2.55656 2.817948 1.198445 5.153886 2.40729 6.40437 2.720513.215472-1.191104.582272-6.307894.708068-6.98634.125173-.674163.52996-1.114021 1.210628-1.239433 3.1424-.576281 3.476818-.463105 3.682948.738399 0 0 .686272 4.24931 1.110988 6.864598.306393.157836.467686-.079529.653888-.219623 5.969067-4.506862 5.473358-4.61698 6.977924-3.209923.419734.39214.81518.813034 1.198172 1.24188.543662.608093.449004.428235-4.764667 7.449445"
            />
          </g>
        </HeaderIllustration>
      </AppHeaderPortal.Source>

      <BugReportHeader>
        <BaseSVG viewBox="0 0 360 46">
          <path
            fill={theme.colors.green}
            fillRule="evenodd"
            d="M0 0h360v17l-.055095.00034c-.240482 1.238536-1.246316 2.228744-2.963361 3.21666l-.4433.246672-.47265.247426-.501814.24903c-9.719426 4.671986-19.542238 5.682998-30.302892 4.934432l-1.378859-.104974c-.922722-.07616-1.852494-.164478-2.78983-.263783l-1.411742-.15705-1.423475-.172652-1.435592-.187374a180.431435 180.431435 0 01-.722462-.098933l-1.454493-.207808-1.467577-.220332-.738815-.114588c-7.963257-1.24599-14.619867-.629564-20.157966.710303l-.865169.217404c-.427965.111542-.84902.227219-1.263257.34647l-.819414.243106-.801399.251641-.78355.259182-.385133.132107-.943623.336609-.916441.34411-.713797.27938-.69677.281939-.679908.283501-.663211.284068-.646677.283637-1.244414.562-4.1059 1.920613-.243349.110907c-6.756477 3.06195-14.264847 4.167557-22.392143 3.716547l-.684326-.039129-1.329565-.085433-1.279287-.094866c-3.137208-.248824-5.82375-.584577-8.214814-.995957l-.941035-.168559c-.617341-.115026-1.215142-.235322-1.796345-.360675l-.970142-.217362-.941517-.226822a60.575733 60.575733 0 01-.916078-.23605l-1.114183-.307685-1.085645-.321287-.852153-.266519-.421719-.136342-.836713-.278705-.830406-.28654-1.240755-.443991-.828584-.30511-1.252968-.470758-3.476444-1.326632-1.85979-.698711-1.468952-.537995-1.544429-.549091-1.076867-.371839-1.118383-.37619-1.163088-.380307a141.593986 141.593986 0 00-.599304-.191627l-1.236124-.38605-1.288799-.38959c-.438734-.130427-.886778-.261405-1.344664-.392895l-1.403716-.39597a161.431559 161.431559 0 00-.724999-.199064l-1.498273-.400145c-.510418-.13381-1.032006-.268036-1.565296-.402638-10.58118-2.670282-18.198375-.966242-24.761785 2.061173l-.71192.335367-.352997.171345-.700412.349466-.69343.357764-.686997.365183-.681118.371722-.675787.37738-1.004894.574753-.664875.387675-.661474.390253-.987041.588286-2.614907 1.564842-.652803.385551c-1.306154.767372-2.616704 1.5106-3.951489 2.197997-15.404771 7.931938-28.282402 8.324306-40.449151 6.119708l-1.026525-.192376-1.023383-.204077-1.020486-.215115a103.239191 103.239191 0 01-.509233-.11149l-1.016597-.23043-1.014308-.23981a123.744496 123.744496 0 01-.506372-.123217l-1.011333-.25264-1.009653-.260364-1.511864-.403578-1.509455-.417229-2.010281-.573673-1.507033-.44038-2.093827-.621432-3.146759-.941438-2.105064-.625077-2.113412-.616046-1.538098-.437414-1.544478-.427241-1.03361-.27805-1.037068-.271838-1.040772-.26495a136.50513 136.50513 0 00-.521853-.129682l-1.046796-.253353-1.051121-.244776a114.450845 114.450845 0 00-.52726-.11896l-1.058077-.230643c-.707006-.150414-1.41731-.293984-2.131242-.429808l-1.073662-.197813c-11.302906-2.013676-23.547161-1.99407-38.02677 3.58021l-.68103.265715a95.652282 95.652282 0 00-.350989.139495l-1.091852.443188-1.144913.477-1.191198.506645-1.23071.532126-1.263449.55344-1.941737.861015-1.977294.885542-6.167877 2.775705-2.057202.915403-1.956525.85669-1.383257.592874-.875066.367282-.833001.342213-.787183.314837-.737608.28515c-2.010394.761826-4.36384 1.385418-6.873434 1.771629H7.985715C5.117783 45.506004 2.371084 44.55169 0 43.003444V0z"
          />
        </BaseSVG>
      </BugReportHeader>

      <BugReportForm onSubmit={submitBug}>
        <label htmlFor="bugreport-description">
          <Text color="greenDark" mb="m">
            Please describe the bug you&apos;re facing. <span aria-hidden="true">*</span>
          </Text>
          <Textarea
            required
            fullWidth
            height="30vh"
            value={description.value}
            id="bugreport-description"
            placeholder="e.g. when clicking on a plant it loads wrong data"
            aria-describedby="bugreport-description"
            aria-invalid={description.invalid}
            error={description.error}
            onChange={(event) => setDescription((d) => ({ ...d, value: event.target.value }))}
          />
        </label>

        <label htmlFor="bugreport-screenshot">
          <Text color="greenDark" mb="m">
            You can upload a screenshot of the bug you&apos;re having.
          </Text>
          <Input type="file" onFileInput={({ file }) => setFile((f) => ({ ...f, value: file }))} />
        </label>

        <Button aria-disabled={description.value === ''} mt="m">
          {isProgress && <Spinner aria-hidden="true" focusable="false" />}
          Submit bug report
        </Button>
      </BugReportForm>
    </Layout>
  )
}
